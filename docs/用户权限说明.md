# 数据资产管理平台 - 用户权限说明文档

## 📋 目录

- [系统概述](#系统概述)
- [角色定义](#角色定义)
- [测试账号](#测试账号)
- [权限对比表](#权限对比表)
- [页面访问权限](#页面访问权限)
- [API权限说明](#api权限说明)
- [权限检查机制](#权限检查机制)
- [常见问题](#常见问题)

---

## 系统概述

本平台采用基于角色的访问控制(RBAC)系统,将用户分为三种角色:
- 业务用户 (BUSINESS_USER)
- 资产管理员 (ASSET_MANAGER)
- 系统管理员 (SYSTEM_ADMIN)

每个角色拥有不同的权限范围,确保数据安全和操作规范。

---

## 角色定义

### 🔵 业务用户 (BUSINESS_USER)

**角色定位**: 数据消费者,需要查找和使用数据资产的业务人员

**核心职责**:
- 浏览和搜索数据资产
- 查看资产详情和元数据
- 收藏常用资产
- 提交数据访问申请
- 查看和管理自己的申请

**权限范围**:
- ✅ 资产查看权限 (read)
- ✅ 申请创建权限 (write applications)
- ✅ 查看自己的申请 (read own applications)
- ❌ 不能创建/编辑/删除资产
- ❌ 不能审核他人的申请
- ❌ 不能访问管理功能

**典型用户**: 业务分析师、数据分析师、产品经理等

---

### 🟢 资产管理员 (ASSET_MANAGER)

**角色定位**: 数据管理者,负责数据资产的维护和申请审核

**核心职责**:
- 创建、编辑、删除数据资产
- 管理资产元数据和标签
- 审核数据访问申请
- 管理资产生命周期
- 维护数据质量

**权限范围**:
- ✅ 资产全部管理权限 (read/write/delete/manage)
- ✅ 申请审核权限 (read/write/manage applications)
- ✅ 查看所有用户的申请
- ✅ 批量操作资产和申请
- ❌ 不能管理用户和权限
- ❌ 不能访问系统后台

**典型用户**: 数据治理专员、数据管理员、DBA等

---

### 🔴 系统管理员 (SYSTEM_ADMIN)

**角色定位**: 系统管理者,拥有最高权限

**核心职责**:
- 用户账号管理
- 权限配置管理
- 系统配置和维护
- 审计日志查看
- SSO集成配置
- 全部资产和申请管理

**权限范围**:
- ✅ 所有资产管理权限
- ✅ 所有申请管理权限
- ✅ 用户管理权限 (read/write/manage users)
- ✅ 后台管理权限 (read/write/manage admin)
- ✅ 系统配置权限
- ✅ 审计日志访问

**典型用户**: IT管理员、系统管理员、平台负责人等

---

## 测试账号

以下是系统种子数据中预设的测试账号:

| 角色 | 邮箱 | 密码 | 姓名 | 部门 |
|------|------|------|------|------|
| 系统管理员 | admin@company.com | admin123 | 系统管理员 | IT部门 |
| 资产管理员 | manager@company.com | manager123 | 资产管理员 | 数据部门 |
| 业务用户 | user@company.com | user123 | 业务用户 | 业务部门 |

**注意事项**:
- 测试账号仅用于开发和演示环境
- 生产环境请立即修改默认密码
- 建议使用SSO集成进行用户认证

---

## 权限对比表

### 功能权限对比

| 功能模块 | 业务用户 | 资产管理员 | 系统管理员 |
|---------|---------|-----------|-----------|
| **资产浏览** | ✅ 查看 | ✅ 查看 | ✅ 查看 |
| **资产搜索** | ✅ 全文搜索 | ✅ 全文搜索 | ✅ 全文搜索 |
| **资产详情** | ✅ 查看 | ✅ 查看 | ✅ 查看 |
| **创建资产** | ❌ 无权限 | ✅ 可创建 | ✅ 可创建 |
| **编辑资产** | ❌ 无权限 | ✅ 可编辑 | ✅ 可编辑 |
| **删除资产** | ❌ 无权限 | ✅ 可删除 | ✅ 可删除 |
| **资产分类管理** | ❌ 无权限 | ✅ 可管理 | ✅ 可管理 |
| **元数据版本** | ✅ 查看 | ✅ 管理 | ✅ 管理 |
| **收藏资产** | ✅ 可收藏 | ✅ 可收藏 | ✅ 可收藏 |
| **创建申请** | ✅ 可创建 | ✅ 可创建 | ✅ 可创建 |
| **查看申请** | ✅ 仅自己的 | ✅ 所有申请 | ✅ 所有申请 |
| **审核申请** | ❌ 无权限 | ✅ 可审核 | ✅ 可审核 |
| **批量操作** | ❌ 无权限 | ✅ 可操作 | ✅ 可操作 |
| **用户管理** | ❌ 无权限 | ❌ 无权限 | ✅ 可管理 |
| **权限管理** | ❌ 无权限 | ❌ 无权限 | ✅ 可管理 |
| **审计日志** | ❌ 无权限 | ❌ 无权限 | ✅ 可查看 |
| **系统配置** | ❌ 无权限 | ❌ 无权限 | ✅ 可配置 |

### 数据访问权限

| 数据类型 | 业务用户 | 资产管理员 | 系统管理员 |
|---------|---------|-----------|-----------|
| 公开资产 (PUBLIC) | ✅ 可见 | ✅ 可见 | ✅ 可见 |
| 内部资产 (INTERNAL) | ✅ 可见 | ✅ 可见 | ✅ 可见 |
| 机密资产 (CONFIDENTIAL) | ⚠️ 需申请 | ✅ 可见 | ✅ 可见 |
| 自己的申请 | ✅ 可见 | ✅ 可见 | ✅ 可见 |
| 他人的申请 | ❌ 不可见 | ✅ 可见 | ✅ 可见 |
| 用户信息 | ❌ 不可见 | ❌ 不可见 | ✅ 可见 |
| 审计日志 | ❌ 不可见 | ❌ 不可见 | ✅ 可见 |

---

## 页面访问权限

### 🔵 业务用户可访问页面

#### 首页和导航
- `/` - 平台首页
- `/dashboard` - 个人工作台

#### 资产相关
- `/assets/browse` - 浏览资产列表
- `/assets/:id` - 查看资产详情
- `/assets/favorites` - 我的收藏
- `/assets/search` - 搜索资产

#### 申请相关
- `/applications` - 我的申请列表
- `/applications/create` - 创建新申请
- `/applications/:id` - 查看申请详情

#### 个人中心
- `/profile` - 个人信息
- `/settings` - 个人设置

### 🟢 资产管理员额外可访问

在业务用户权限基础上,额外可访问:

#### 管理后台
- `/admin/assets` - 资产管理控制台
- `/admin/assets/new` - 创建新资产
- `/admin/assets/:id/edit` - 编辑资产

#### 申请管理
- `/applications` - 可查看所有用户的申请(而非仅自己的)

### 🔴 系统管理员额外可访问

在资产管理员权限基础上,额外可访问:

#### 系统后台
- `/admin` - 后台管理首页(包含系统监控、日志、配置等)
- `/admin/users` - 用户管理
- `/admin/sso` - SSO配置和监控
- `/admin/sso/permissions` - SSO权限映射
- `/admin/sso/monitoring` - SSO监控面板

---

## API权限说明

### tRPC API端点权限

#### 公开端点 (publicProcedure)
无需登录即可访问:
```typescript
// 不需要认证的API
- 登录/登出/注册
- 公开的资产列表(仅PUBLIC级别)
```

#### 受保护端点 (protectedProcedure)
需要登录,所有角色均可访问:
```typescript
// 需要登录的API
- 查看资产详情
- 搜索资产
- 查看自己的申请
- 管理个人收藏
```

#### 管理员端点 (adminProcedure)
仅资产管理员和系统管理员可访问:
```typescript
// 需要管理员权限的API
- 创建/编辑/删除资产
- 审核申请
- 管理分类
- 批量操作
```

#### 系统管理员端点 (systemAdminProcedure)
仅系统管理员可访问:
```typescript
// 需要系统管理员权限的API
- 用户管理
- 权限管理
- 审计日志
- 系统配置
```

### 权限装饰器说明

代码位置: `src/lib/trpc.ts`

```typescript
// 1. 公开访问
export const publicProcedure = t.procedure

// 2. 需要登录
export const protectedProcedure = t.procedure.use(/* 检查登录状态 */)

// 3. 需要管理员权限(资产管理员或系统管理员)
export const adminProcedure = protectedProcedure.use(
  async ({ ctx, next }) => {
    const isAdmin = ctx.user.role === 'SYSTEM_ADMIN' ||
                    ctx.user.role === 'ASSET_MANAGER'
    if (!isAdmin) throw new TRPCError({ code: 'FORBIDDEN' })
    return next()
  }
)

// 4. 仅系统管理员
export const systemAdminProcedure = protectedProcedure.use(
  async ({ ctx, next }) => {
    if (ctx.user.role !== 'SYSTEM_ADMIN') {
      throw new TRPCError({ code: 'FORBIDDEN' })
    }
    return next()
  }
)
```

---

## 权限检查机制

### 三层权限检查架构

#### 1️⃣ 中间件层 (Middleware)

**位置**: `src/middleware.ts`

**作用**: 路由级别的权限检查,在请求到达页面前拦截

```typescript
const protectedRoutes = {
  // 仅系统管理员
  '/admin': { resource: 'admin', action: 'read', roles: ['SYSTEM_ADMIN'] },
  '/admin/users': { resource: 'users', action: 'read', roles: ['SYSTEM_ADMIN'] },

  // 管理员(资产管理员 + 系统管理员)
  '/assets/manage': { resource: 'assets', action: 'manage',
                      roles: ['ASSET_MANAGER', 'SYSTEM_ADMIN'] },
  '/applications/review': { resource: 'applications', action: 'manage',
                            roles: ['ASSET_MANAGER', 'SYSTEM_ADMIN'] },
}
```

**特点**:
- 最早拦截,性能最好
- 直接返回403或重定向到登录页
- 适合整个页面级别的权限控制

#### 2️⃣ API层 (tRPC Procedures)

**位置**: `src/lib/trpc.ts` 和 `src/server/routers/*.ts`

**作用**: API调用时的权限验证

```typescript
// 示例: 创建资产API
export const assetsRouter = createTRPCRouter({
  createAsset: adminProcedure  // 使用adminProcedure装饰器
    .input(CreateAssetSchema)
    .mutation(async ({ ctx, input }) => {
      // 只有管理员能执行到这里
      return AssetService.create(input)
    }),
})
```

**特点**:
- 每个API独立验证
- 提供详细的错误信息
- 支持细粒度的权限控制

#### 3️⃣ 组件层 (UI Components)

**位置**: `src/components/common/PermissionGuard.tsx`

**作用**: 组件级别的UI显示控制

```typescript
// 示例: 条件渲染按钮
<PermissionGuard resource="assets" action="write">
  <Button>创建资产</Button>
</PermissionGuard>

// 或使用Hook
const { hasPermission } = usePermission()
{hasPermission('assets', 'write') && <Button>创建</Button>}
```

**特点**:
- 最细粒度的控制
- 优化用户体验(隐藏无权限按钮)
- 不能单独使用,必须配合API层验证

### 权限判断流程

```
用户请求页面/API
    ↓
【中间件层】检查路由权限
    ↓ (通过)
【tRPC层】检查API权限
    ↓ (通过)
【服务层】执行业务逻辑
    ↓
【组件层】根据权限显示UI
```

### 数据级权限控制

除了功能权限,还有数据级别的权限控制:

#### 业务用户查看申请限制

**位置**: `src/server/routers/application.ts:273-277`

```typescript
// 业务用户只能看到自己创建的申请
if (ctx.user.role === 'BUSINESS_USER') {
  where.userId = ctx.user.id  // 强制过滤
}
```

#### 业务用户修改申请限制

**位置**: `src/server/routers/application.ts:365-369`

```typescript
// 业务用户只能修改自己的申请
if (ctx.user.role === 'BUSINESS_USER') {
  const application = await prisma.application.findUnique({
    where: { id: input.id }
  })
  if (application.userId !== ctx.user.id) {
    throw new TRPCError({ code: 'FORBIDDEN' })
  }
}
```

---

## 常见问题

### Q1: 如何修改用户角色?

**系统管理员可以通过以下方式修改**:

1. **通过后台界面** (推荐)
   - 登录系统管理员账号
   - 访问 `/admin/users`
   - 选择用户,点击编辑
   - 修改角色后保存

2. **通过数据库**
   ```sql
   -- 使用Prisma Studio
   npm run db:studio
   -- 找到User表,修改role字段
   ```

3. **通过API**
   ```typescript
   // 调用用户管理API
   trpc.admin.updateUser.mutate({
     userId: 'xxx',
     role: 'ASSET_MANAGER'
   })
   ```

### Q2: 业务用户如何申请管理员权限?

**流程**:
1. 联系系统管理员
2. 提供业务需求说明
3. 管理员评估后通过后台授权
4. 用户需要重新登录以更新权限

### Q3: 权限检查失败会显示什么?

**不同层级的表现**:
- **中间件层**: 重定向到403错误页或登录页
- **API层**: 返回`FORBIDDEN`错误,前端显示错误提示
- **组件层**: 相关按钮/功能不显示

### Q4: SSO登录的用户如何分配角色?

**SSO用户角色分配策略**:

1. **首次登录**
   - 默认分配为业务用户(BUSINESS_USER)
   - 记录在`users`表中

2. **角色提升**
   - 由系统管理员手动提升
   - 或通过SSO属性映射自动分配

3. **配置文件**
   ```env
   # .env配置
   SSO_DEFAULT_ROLE=BUSINESS_USER
   SSO_ADMIN_GROUPS=admin,data-admin  # LDAP组映射
   ```

### Q5: 如何查看用户操作日志?

**仅系统管理员可以查看**:
1. 登录系统管理员账号
2. 访问 `/admin/audit`
3. 可以筛选:
   - 用户
   - 操作类型
   - 时间范围
   - 资源对象

**日志包含信息**:
- 操作人
- 操作时间
- 操作类型(创建/修改/删除/查看)
- 操作对象(资产/申请/用户)
- 操作结果(成功/失败)
- IP地址

### Q6: 权限系统如何扩展?

**如需添加新角色**:

1. **修改Prisma Schema**
   ```prisma
   // prisma/schema.prisma
   enum UserRole {
     BUSINESS_USER
     ASSET_MANAGER
     SYSTEM_ADMIN
     DATA_ANALYST  // 新增角色
   }
   ```

2. **更新权限配置**
   ```typescript
   // prisma/seed.ts - 添加权限规则
   { resource: 'reports', action: 'read', role: 'DATA_ANALYST' }
   ```

3. **更新中间件路由**
   ```typescript
   // src/middleware.ts
   '/reports': { roles: ['DATA_ANALYST', 'SYSTEM_ADMIN'] }
   ```

4. **运行数据库迁移**
   ```bash
   npm run db:push
   npx tsx prisma/seed.ts
   ```

### Q7: 如何临时禁用用户?

**系统管理员操作**:
1. 访问 `/admin/users`
2. 找到目标用户
3. 点击"禁用"按钮
4. 用户下次请求时会被拒绝

**数据库字段**:
```prisma
model User {
  isActive Boolean @default(true)  // 设置为false即禁用
}
```

### Q8: 不同角色的默认首页是什么?

**登录后重定向规则**:
- 业务用户 → `/dashboard` (个人工作台)
- 资产管理员 → `/assets/manage` (资产管理)
- 系统管理员 → `/admin` (后台首页)

**配置位置**: `src/app/(auth)/login/page.tsx`

---

## 附录

### A. 权限资源列表

| 资源(Resource) | 说明 |
|---------------|------|
| assets | 资产管理 |
| applications | 申请管理 |
| users | 用户管理 |
| admin | 后台管理 |
| categories | 分类管理 |
| favorites | 收藏管理 |

### B. 权限动作列表

| 动作(Action) | 说明 |
|-------------|------|
| read | 读取/查看 |
| write | 创建/修改 |
| delete | 删除 |
| manage | 完全管理(包含上述所有) |

### C. 相关文件列表

| 文件路径 | 说明 |
|---------|------|
| `prisma/schema.prisma` | 数据库Schema,角色定义 |
| `prisma/seed.ts` | 种子数据,权限配置 |
| `src/lib/trpc.ts` | tRPC配置,权限装饰器 |
| `src/middleware.ts` | Next.js中间件,路由权限 |
| `src/lib/permissions.ts` | 权限检查工具函数 |
| `src/components/common/PermissionGuard.tsx` | 权限守卫组件 |
| `src/server/routers/` | API路由,权限验证 |

---

**文档版本**: v1.0
**更新日期**: 2024-01-XX
**维护人员**: 系统管理员

如有疑问或需要支持,请联系IT部门。
